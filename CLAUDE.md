# CLAUDE.md

This file provides guidance to Claude Code when working with the Qubx quantitative trading framework.

## Project Overview

Qubx is a quantitative trading framework for backtesting and live trading strategies. Built with Python, it uses Poetry for dependency management and supports multiple exchanges via CCXT.

## Plan & Review Workflow

### Before starting work

- Always plan complex tasks first
- **IMPORTANT**: Write plans to `.claude/tasks/NNN_TASK_NAME.md` with sequential numbering
  - **MUST check existing tasks first**: Use `ls .claude/tasks/` to see existing task files
  - **MUST increment task counter**: Find the highest existing task number and add +1
  - **Example**: If tasks 001, 002, 003 exist, your new task should be 004
  - **Never reuse numbers**: Each task must have a unique sequential number
- Research external knowledge if needed (Use Task tool)
- Ask for plan review before implementation
- When continuing tasks, review context and provide roadmap summary
- If asked to resume/continue a task by name or number, first read the task file, then read all relevant files before continuing work

### While implementing

- Update the plan as you work
- Append detailed descriptions of changes for handover

## Common Commands

### Development

```bash
# Install dependencies
poetry install

# Install dev dependencies
just dev-install

# Linting and style check
just style-check

# Testing
just test

# Testing with verbose output
just test-verbose

# Integration tests
just test-integration

# End-to-end tests
just test-e2e

# Build package
just build

# Update documentation
just update-docs
```

### Strategy Development

```bash
# Create new strategy from template (defaults to 'simple')
poetry run qubx init --name my_strategy --symbols BTCUSDT,ETHUSDT --exchange BINANCE.UM

# Create strategy with specific template
poetry run qubx init --name my_strategy --template project

# List available templates
poetry run qubx init --list-templates

# Run strategy with configuration
poetry run qubx run config.yml --paper

# Run strategy simulation
poetry run qubx simulate config.yml

# List strategies in directory
poetry run qubx ls

# Package strategy into release
poetry run qubx release --config config.yml

# Deploy strategy from zip file
poetry run qubx deploy --file strategy.zip

# Browse backtest results
poetry run qubx browse results/

# Show all CLI commands
poetry run qubx --help
```

## Development Guidelines

- Use `poetry run` for all Python commands
- Make commit messages concise - don't add "generated by claude"
- Use lowercase with underscores for Python files
- Always use logger imported from qubx package: `from qubx import logger`
- Use new Python types: `list`, `dict`, `| None`, `tuple` instead of importing from typing
- Only import `Any` type from typing if needed

## Core Architecture

### Key Directories

- `src/qubx/`: Main framework source code
- `examples/`: Example strategies and configurations
- `tests/`: Test suites and fixtures
- `experiments/`: Research notebooks
- `docs/`: Documentation

### Core Interfaces

The main interfaces are in `src/qubx/core/interfaces.py`:

- **IStrategy**: Base class for trading strategies with lifecycle methods
- **IStrategyContext**: Provides market data, account info, and trading operations
- **IAccountProcessor**: Handles account state and order execution
- **ISubscriptionManager**: Manages market data subscriptions

### Strategy Configuration

Strategies use YAML configuration files with a `live` section:

```yaml
strategy: package.module.StrategyClass
parameters:
  param1: value1
  param2: value2
live:
  read_only: false
  exchanges:
    BINANCE.UM:
      connector: ccxt
      universe:
        - BTCUSDT
        - ETHUSDT
  logging:
    logger: InMemoryLogsWriter
    position_interval: 10Sec
    portfolio_interval: 5Min
    heartbeat_interval: 10m
```

### Strategy Templates

Use `poetry run qubx init` to create strategies from templates:

- **simple**: Basic strategy structure with flat directory layout for quick prototyping
- **project**: Full project template with nested structure, pyproject.toml, and MACD example strategy
- Custom templates can be created in `src/qubx/templates/`

Generated strategies include:

- Strategy class with proper IStrategy implementation
- Configuration file for paper/live trading
- Executable `jpaper.sh` script for Jupyter mode
- Project structure compatible with `qubx run`

## Testing & Quality

- Use pytest with asyncio support
- Unit tests: `tests/qubx/` (mirrors `src/qubx/` structure)
- Integration tests: `tests/integration/`
- E2E tests: `tests/e2e/`
- Mark integration tests with `@pytest.mark.integration`
- Mark e2e tests with `@pytest.mark.e2e`
- Run `just style-check` before committing
- Use ruff for linting (120 char line limit)
- Disable warnings during tests with `--disable-warnings`

## Important Notes

- Never hardcode secrets or API keys
- Use environment variables for sensitive configuration
- Always test strategies in simulation before live deployment
